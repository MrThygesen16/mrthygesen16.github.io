{"_path":"/blog/secure-variable-injection","_dir":"blog","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"Secure Environment Variable Injection using AzAPI & AzureRM","description":"2025/08/05","date":"2025/08/05","draft":false,"layout":"full-width","body":{"type":"root","children":[{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h1","props":{"id":"secure-environment-variable-injection-using-azapi-azurerm"},"children":[{"type":"text","value":"Secure Environment Variable Injection using AzAPI & AzureRM"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2025/08/05"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"framing-the-problem"},"children":[{"type":"text","value":"Framing the problem"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://github.com/MrThygesen16/tf-aci-secret-inject","rel":["nofollow"]},"children":[{"type":"text","value":"Full code can be found here."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"When creating Container Instances in Azure, it is recommended to provision a Managed Identity alongside the Container Instance. We can use this Managed Identity to generate an Entra ID token & use that for Authentication. A prime example would be provisioning Container Instances for privately hosted Azure DevOps agents."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The benefits of this approach means we don't have to worry about handling secrets; no need for a key-vault or secure variables in Azure DevOps. More importantly, this means we are not writing any secrets to State in Terraform. Writing secrets directly to state leads to a problem called "},{"type":"element","tag":"a","props":{"href":"https://www.hashicorp.com/en/resources/what-is-secret-sprawl-why-is-it-harmful","rel":["nofollow"]},"children":[{"type":"text","value":"\"Secret Sprawl\""}]},{"type":"text","value":":"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Secret Sprawl is the uncontrolled and unmanaged proliferation of sensitive information like API keys, passwords, and encryption keys across an organization's digital environment. This happens when these secrets are scattered across various systems, applications, and even unsecured communication channels without proper tracking or control."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The above solution works well when using a Linux-based container image. For Windows Containers however, it is a different story."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://learn.microsoft.com/en-us/azure/container-instances/container-instances-managed-identity#managed-identity-on-windows-containers","rel":["nofollow"]},"children":[{"type":"text","value":"Microsoft Documentation on Container Instances highlights this issue:"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Managed Identity on Windows container groups works differently than Linux container groups. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"For Windows containers, metadata server (169.254.169.254) is not available for getting the Microsoft Entra ID token"}]},{"type":"text","value":"."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The docs further state:"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Az Login module and other client libraries which depend on metadata server (169.254.169.254) will not work in a Windows Container. Additionally, Windows containers in vNet won't be able to connect to the endpoint; hence, a managed identity token can't be generated in a Windows virtual network container."}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Essentially, doing the approach described above (using a managed identity to create an Entra ID token) is not possible."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Let's take the following Terraform snippet(s) as an example:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"First we will create a resource group"}]}]},{"type":"element","tag":"code","props":{"className":["language-hcl"],"code":"# main.tf\nresource \"azurerm_resource_group\" \"this\" {\n  name     = \"rg-acg-example-01\"\n  location = \"AustraliaEast\"\n}\n\n","language":"hcl","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# main.tf\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"resource"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"azurerm_resource_group\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"this\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  name"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"     "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"rg-acg-example-01\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  location"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"AustraliaEast\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"ol","props":{"start":2},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create a container group"}]}]},{"type":"element","tag":"code","props":{"className":["language-hcl"],"code":"# main.tf (cont.) - Insecure Windows Container Group\nresource \"azurerm_container_group\" \"unsecure\" {\n  name                = \"acg-windows-insecure-01\"\n  location            = azurerm_resource_group.this.location\n  resource_group_name = azurerm_resource_group.this.name\n  os_type             = \"Windows\"\n\n  container {\n    name   = \"aci-win-02\"\n    image  = \"mcr.microsoft.com/windows/servercore:ltsc2022\"\n    cpu    = \"0.5\"\n    memory = \"0.5\"\n\n    ports {\n      port     = \"22\"\n      protocol = \"TCP\"\n    }\n\n    commands = []\n    \n    ## secrets added to state\n    environment_variables = { \n        \"non_secure_var\" = \"NonSecureValueExposed\" \n    }\n    # Would be better to pass this in as a variable\n    # but for the sake of this demo -- this is simpler\n    secure_environment_variables = { \n        \"secure_var\" = \"SecureValueExposed\" \n    }\n  }\n}\n","language":"hcl","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# main.tf (cont.) - Insecure Windows Container Group\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"resource"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"azurerm_container_group\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"unsecure\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  name"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"                "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"acg-windows-insecure-01\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  location"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"azurerm_resource_group"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"location\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  resource_group_name"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"azurerm_resource_group"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  os_type"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"             "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"Windows\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"container"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    name"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"   "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"aci-win-02\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    image"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"mcr.microsoft.com/windows/servercore:ltsc2022\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    cpu"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"0.5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    memory"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"0.5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"ports"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      port"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"     "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"22\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      protocol"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"TCP\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    commands"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"[]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"## secrets added to state\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    environment_variables"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"{ \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"non_secure_var\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" = "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"NonSecureValueExposed\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# Would be better to pass this in as a variable\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# but for the sake of this demo -- this is simpler\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    secure_environment_variables"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"{ \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"secure_var\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" = "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"SecureValueExposed\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can check the Azure portal and confirm that our two environment variables have been added to the Container.\nFurthermore, notice that Azure does not display the value of the environment variable "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"secure_var"}]},{"type":"text","value":"."}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Key"}]},{"type":"element","tag":"th","props":{"align":null},"children":[{"type":"text","value":"Value"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"non_secure_var"}]},{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"NonSecureValue"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{"align":null},"children":[{"type":"text","value":"secure_var"}]},{"type":"element","tag":"td","props":{"align":null},"children":[]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"However, when we look at our State file, we can see that the secrets - including the secure variable is stored in plain-text."}]},{"type":"element","tag":"code","props":{"className":["language-json"],"code":"// terraform.tfstate\n\"environment_variables\": {\n    \"non_secure_var\": \"NonSecureValue\"\n},\n\"secure_environment_variables\": {\n    \"secure_var\": \"SecureValue\"\n},\n","language":"json","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"// terraform.tfstate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"environment_variables\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":": {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-238295"},"children":[{"type":"text","value":"\"non_secure_var\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"NonSecureValue\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"},\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"secure_environment_variables\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":": {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-238295"},"children":[{"type":"text","value":"\"secure_var\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"SecureValue\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"},"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Unfortunately, this means that anyone who has read-access to state can view these secrets."}]},{"type":"element","tag":"h2","props":{"id":"solution"},"children":[{"type":"text","value":"Solution"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We can solve this issue by using AzAPI."}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Create another Container group; this time we don't add the secrets in, and instead add a lifecycle ignore block on the environment variables object (otherwise Terraform will complain)"}]}]},{"type":"element","tag":"code","props":{"className":["language-hcl"],"code":"# main.tf (cont.) Secure Windows Container Group\nresource \"azurerm_container_group\" \"secure\" {\n  name                = \"acg-windows-secure-01\"\n  location            = azurerm_resource_group.this.location\n  resource_group_name = azurerm_resource_group.this.name\n  os_type             = \"Windows\"\n\n  container {\n    name   = \"aci-win-01\"\n    image  = \"mcr.microsoft.com/windows/servercore:ltsc2022\"\n    cpu    = \"0.5\"\n    memory = \"0.5\"\n\n    ports {\n      port     = \"22\"\n      protocol = \"TCP\"\n    }\n\n    ## let azapi inject these secrets\n    # commands = []\n    # environment_variables = {}\n  }\n\n  lifecycle {\n    ignore_changes = [\n      container[0].environment_variables,\n      container[0].commands,\n    ]\n  }\n}\n","language":"hcl","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# main.tf (cont.) Secure Windows Container Group\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"resource"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"azurerm_container_group\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"secure\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  name"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"                "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"acg-windows-secure-01\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  location"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"azurerm_resource_group"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"location\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  resource_group_name"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"azurerm_resource_group"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  os_type"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"             "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"Windows\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"container"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    name"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"   "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"aci-win-01\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    image"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"mcr.microsoft.com/windows/servercore:ltsc2022\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    cpu"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"0.5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    memory"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"0.5\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"ports"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      port"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"     "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"22\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      protocol"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"TCP\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"## let azapi inject these secrets\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# commands = []\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# environment_variables = {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"lifecycle"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    ignore_changes"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      container["}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"]"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"environment_variables,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      container["}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"]"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"commands,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    ]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"ol","props":{"start":2},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Next we use AzAPI to Stop the container by sending a POST request to the Container Group"}]}]},{"type":"element","tag":"code","props":{"className":["language-hcl"],"code":"# main.tf (cont.) stop container group\nresource \"azapi_resource_action\" \"stop_container_group\" {\n  type        = \"Microsoft.ContainerInstance/containerGroups@2023-05-01\"\n  resource_id = azurerm_container_group.secure.id\n  action      = \"stop\"\n  method      = \"POST\"\n}\n","language":"hcl","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# main.tf (cont.) stop container group\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"resource"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"azapi_resource_action\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"stop_container_group\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  type"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"Microsoft.ContainerInstance/containerGroups@2023-05-01\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  resource_id"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"azurerm_container_group"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"secure"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"id\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  action"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"stop\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  method"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"POST\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"ol","props":{"start":3},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Also using AzAPI, we use the resource "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"update_resource"}]},{"type":"text","value":" to inject the variables."}]}]},{"type":"element","tag":"code","props":{"className":["language-hcl"],"code":"# main.tf (cont.) inject secrets\nresource \"azapi_update_resource\" \"inject_secrets\" {\n  type        = \"Microsoft.ContainerInstance/containerGroups@2023-05-01\"\n  resource_id = azurerm_container_group.secure.id\n  \n  # rather than using `body`, we use `sensitive_body`\n  sensitive_body = {\n    properties = {\n      containers = [\n        {\n          name = azurerm_container_group.secure.container[0].name\n          properties = {\n            environmentVariables = [\n              {\n                name  = \"non_secure_var\"\n                value = \"NonSecureValueHidden\"\n              },\n              {\n                name        = \"secure_var\"\n                secureValue = \"SecureValueHidden\"\n              }\n            ]\n          }\n        }\n      ]\n    }\n  }\n}\n","language":"hcl","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# main.tf (cont.) inject secrets\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"resource"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"azapi_update_resource\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"inject_secrets\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  type"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"Microsoft.ContainerInstance/containerGroups@2023-05-01\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  resource_id"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"azurerm_container_group"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"secure"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"id\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# rather than using `body`, we use `sensitive_body`\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  sensitive_body"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    properties "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      containers "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"        {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"          name "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" azurerm_container_group.secure.container["}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"].name\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"          properties "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"            environmentVariables "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" [\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"              {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"                name  "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"non_secure_var\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"                value "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"NonSecureValueHidden\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"              },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"              {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"                name        "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"secure_var\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"                secureValue "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"SecureValueHidden\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"              }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"            ]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"          }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"      ]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The reason we are able to update these values and not have them written to state is due to the introduction of "},{"type":"element","tag":"a","props":{"href":"https://registry.terraform.io/providers/Azure/azapi/latest/docs/guides/feature_ephemeral_resource#write-only-attributes","rel":["nofollow"]},"children":[{"type":"text","value":"\"Ephemeral Resources & Write-Only Attributes in Terraform\""}]},{"type":"text","value":":"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Write-only arguments let you securely pass temporary values to Terraform's managed resources during an operation without persisting those values to state or plan files."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The AzAPI provider supports sensitive_body to define attributes that are not stored in the state file, ensuring sensitive information remains secure"}]}]},{"type":"element","tag":"ol","props":{"start":4},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Lastly, we start the container group again."}]}]},{"type":"element","tag":"code","props":{"className":["language-hcl"],"code":"# main.tf (cont.) start container group\nresource \"azapi_resource_action\" \"start_container_group\" {\n  type        = \"Microsoft.ContainerInstance/containerGroups@2022-05-01\"\n  resource_id = azurerm_container_group.secure.id\n  action      = \"start\"\n  method      = \"POST\"\n\n  depends_on = [\n    azapi_update_resource.inject_secrets, \n    azapi_resource_action.stop_container_group\n  ]\n}\n","language":"hcl","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"# main.tf (cont.) start container group\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"resource"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"azapi_resource_action\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"\"start_container_group\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  type"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"Microsoft.ContainerInstance/containerGroups@2022-05-01\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  resource_id"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"azurerm_container_group"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"secure"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"id\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  action"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"start\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  method"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":"      "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"POST\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  depends_on"}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-443230"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"[\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    azapi_update_resource"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"inject_secrets, \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"    azapi_resource_action"}]},{"type":"element","tag":"span","props":{"class":"ct-942366"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"stop_container_group\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"  ]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This is purely anecdotal, but I've found that stopping, injecting secrets, and then starting the container group yields more consistent results."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Finally, when we take a look at the state file for the container where we injected the secrets, we can see that neither the non-secure, nor the secure environment variables have been written to state."}]},{"type":"element","tag":"code","props":{"className":["language-json"],"code":"// terraforn.tfstate\n\"environment_variables\": null,\n\"secure_environment_variables\": null\n","language":"json","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-128513"},"children":[{"type":"text","value":"// terraforn.tfstate\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"environment_variables\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"null"}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-667011"},"children":[{"type":"text","value":"\"secure_environment_variables\""}]},{"type":"element","tag":"span","props":{"class":"ct-935781"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"class":"ct-998471"},"children":[{"type":"text","value":"null"}]}]}]}]}]},{"type":"element","tag":"style","children":[{"type":"text","value":".dark .ct-128513{color:#8B949E;}\n.ct-128513{color:#6E7781;}\n.dark .ct-667011{color:#A5D6FF;}\n.ct-667011{color:#0A3069;}\n.dark .ct-935781{color:#C9D1D9;}\n.ct-935781{color:#24292F;}\n.dark .ct-238295{color:#7EE787;}\n.ct-238295{color:#116329;}\n.dark .ct-998471{color:#79C0FF;}\n.ct-998471{color:#0550AE;}\n.dark .ct-443230{color:#FFA657;}\n.ct-443230{color:#953800;}\n.dark .ct-942366{color:#FF7B72;}\n.ct-942366{color:#CF222E;}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"framing-the-problem","depth":2,"text":"Framing the problem"},{"id":"solution","depth":2,"text":"Solution"}]}},"_type":"markdown","_id":"content:4.blog:secure-variable-injection.MD","_source":"content","_file":"4.blog/secure-variable-injection.MD","_extension":"MD"}